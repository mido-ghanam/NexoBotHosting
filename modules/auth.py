# -*- coding: utf-8 -*-
"""
ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬
"""

import telebot
from telebot import types
from database import db
from api_client import api_client
from config import config

class AuthManager:
    def __init__(self, bot: telebot.TeleBot):
        self.bot = bot
        self.user_states = {}  # Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    
    def register_handlers(self):
        """ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø±"""
        self.bot.message_handler(commands=['login'])(self.handle_login_command)
        self.bot.message_handler(commands=['logout'])(self.handle_logout_command)
        self.bot.message_handler(func=lambda message: self.is_waiting_for_credentials(message))(self.handle_credentials_input)
    
    def is_waiting_for_credentials(self, message):
        """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„"""
        return message.from_user.id in self.user_states
    
    def handle_login_command(self, message):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"""
        user_id = message.from_user.id
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        user = db.get_user(user_id)
        if user and user.get('is_logged_in'):
            self.bot.reply_to(message, "âœ… Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„!\n\nØ§Ø³ØªØ®Ø¯Ù… /account Ù„Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ.")
            return
        
        # Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        markup = types.InlineKeyboardMarkup()
        email_btn = types.InlineKeyboardButton("ğŸ“§ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„", callback_data="login_email")
        api_btn = types.InlineKeyboardButton("ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ API Key", callback_data="login_api")
        markup.add(email_btn)
        markup.add(api_btn)
        
        self.bot.reply_to(message, 
                         "ğŸ” **ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ù†ØµØ© Nexo**\n\n"
                         "Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:",
                         reply_markup=markup, parse_mode='Markdown')
    
    def handle_logout_command(self, message):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"""
        user_id = message.from_user.id
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        user = db.get_user(user_id)
        if not user or not user.get('is_logged_in'):
            self.bot.reply_to(message, "âŒ Ø£Ù†Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„!")
            return
        
        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        if db.update_user_login_status(user_id, False):
            self.bot.reply_to(message, "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ø³ØªØ®Ø¯Ù… /login Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
        else:
            self.bot.reply_to(message, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
    
    def handle_credentials_input(self, message):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„"""
        user_id = message.from_user.id
        
        if user_id not in self.user_states:
            return
        
        state = self.user_states[user_id]
        
        if state['step'] == 'waiting_email':
            # Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            state['email'] = message.text.strip()
            state['step'] = 'waiting_password'
            self.bot.reply_to(message, "ğŸ”’ Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:")
            
        elif state['step'] == 'waiting_password':
            # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            password = message.text.strip()
            self.attempt_email_login(message, state['email'], password)
            
        elif state['step'] == 'waiting_api_key':
            # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ API Key
            api_key = message.text.strip()
            self.attempt_api_login(message, api_key)
    
    def attempt_email_login(self, message, email, password):
        """Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"""
        user_id = message.from_user.id
        
        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        if user_id in self.user_states:
            del self.user_states[user_id]
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± API
        login_result = api_client.ctrlpanel_login(email, password)
        
        if login_result and login_result.get('success'):
            api_key = login_result.get('api_key') or login_result.get('token')
            
            if api_key:
                # Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if db.add_user(user_id, email, api_key):
                    self.bot.reply_to(message, 
                                     f"âœ… **ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!**\n\n"
                                     f"ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: `{email}`\n"
                                     f"ğŸ• ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\n"
                                     f"Ø§Ø³ØªØ®Ø¯Ù… /account Ù„Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ.",
                                     parse_mode='Markdown')
                else:
                    self.bot.reply_to(message, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
            else:
                self.bot.reply_to(message, "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ API. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„.")
        else:
            error_msg = login_result.get('message', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©') if login_result else 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…'
            self.bot.reply_to(message, f"âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: {error_msg}")
    
    def attempt_api_login(self, message, api_key):
        """Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ API Key"""
        user_id = message.from_user.id
        
        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        if user_id in self.user_states:
            del self.user_states[user_id]
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© API Key
        user_info = api_client.ctrlpanel_get_user_info(api_key)
        
        if user_info and user_info.get('success'):
            email = user_info.get('data', {}).get('email', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')
            
            # Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if db.add_user(user_id, email, api_key):
                self.bot.reply_to(message, 
                                 f"âœ… **ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!**\n\n"
                                 f"ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: `{email}`\n"
                                 f"ğŸ”‘ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… API Key\n"
                                 f"ğŸ• ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\n"
                                 f"Ø§Ø³ØªØ®Ø¯Ù… /account Ù„Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ.",
                                 parse_mode='Markdown')
            else:
                self.bot.reply_to(message, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
        else:
            self.bot.reply_to(message, "âŒ API Key ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.")
    
    def handle_callback_query(self, call):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©"""
        if call.data == "login_email":
            self.user_states[call.from_user.id] = {'step': 'waiting_email'}
            self.bot.edit_message_text(
                "ğŸ“§ **ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„**\n\nØ£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:",
                call.message.chat.id,
                call.message.message_id,
                parse_mode='Markdown'
            )
            
        elif call.data == "login_api":
            self.user_states[call.from_user.id] = {'step': 'waiting_api_key'}
            self.bot.edit_message_text(
                "ğŸ”‘ **ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ API Key**\n\n"
                "Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:\n"
                "(ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)",
                call.message.chat.id,
                call.message.message_id,
                parse_mode='Markdown'
            )
    
    def is_user_logged_in(self, user_id: int) -> bool:
        """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        user = db.get_user(user_id)
        return user and user.get('is_logged_in', False)
    
    def get_user_api_key(self, user_id: int) -> str:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ API Key Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        user = db.get_user(user_id)
        return user.get('api_key') if user else None
    
    def require_login(self, func):
        """Ø¯ÙŠÙƒÙˆØ±ÙŠØªØ± Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ø§Ù„Ø©"""
        def wrapper(message):
            if not self.is_user_logged_in(message.from_user.id):
                self.bot.reply_to(message, 
                                 "ğŸ” ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!\n\n"
                                 "Ø§Ø³ØªØ®Ø¯Ù… /login Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.")
                return
            return func(message)
        return wrapper

from datetime import datetime

